<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Utilities for handling droplet-based single-cell RNA-seq data • DropletUtils</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Utilities for handling droplet-based single-cell RNA-seq data">
<meta property="og:description" content="DropletUtils">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">DropletUtils</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.13.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/DropletUtils.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="DropletUtils_files/header-attrs-2.9/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Utilities for handling droplet-based single-cell RNA-seq data</h1>
                        <h4 class="author">Aaron Lun</h4>
            
      
      
      <div class="hidden name"><code>DropletUtils.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>Droplet-based single-cell RNA sequencing (scRNA-seq) technologies allow researchers to obtain transcriptome-wide expression profiles for thousands of cells at once. Briefly, each cell is encapsulated in a droplet in a oil-water emulsion, along with a bead containing reverse transcription primers with a unique barcode sequence. After reverse transcription inside the droplet, each cell’s cDNA is labelled with that barcode (referred to a “cell barcode”). Bursting of the droplets yields a pool of cDNA for library preparation and sequencing. Debarcoding of the sequences can then be performed to obtain the expression profile for each cell.</p>
<p>This package implements some general utilities for handling these data after quantification of expression. In particular, we focus on the 10X Genomics platform, providing functions to load in the matrix of unique molecule identifier (UMI) counts as well as the raw molecule information. Functions are also available for downsampling the UMI count matrix or the raw reads; for distinguishing cells from empty droplets, based on the UMI counts; and to eliminate the effects of barcode swapping on Illumina 4000 sequencing machine.</p>
</div>
<div id="reading-in-10x-genomics-data" class="section level1">
<h1 class="hasAnchor">
<a href="#reading-in-10x-genomics-data" class="anchor"></a>Reading in 10X Genomics data</h1>
<div id="from-the-umi-count-matrix" class="section level2">
<h2 class="hasAnchor">
<a href="#from-the-umi-count-matrix" class="anchor"></a>From the UMI count matrix</h2>
<p>The <em>CellRanger</em> pipeline from 10X Genomics will process the raw sequencing data and produce a matrix of UMI counts. Each row of this matrix corresponds to a gene, while each column corresponds to a cell barcode. This is saved in a single directory for each sample, usually named like <code>&lt;OUTPUT&gt;/outs/filtered_gene_bc_matrices/&lt;GENOME&gt;</code><a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>. We mock up an example directory below using some simulated data:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># To generate the files.</span>
<span class="fu"><a href="https://rdrr.io/r/utils/example.html">example</a></span><span class="op">(</span><span class="va">write10xCounts</span>, echo<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> 
<span class="va">dir.name</span> <span class="op">&lt;-</span> <span class="va">tmpdir</span>
<span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="va">dir.name</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "barcodes.tsv" "genes.tsv"    "matrix.mtx"</code></pre>
<p>The <code>matrix.mtx</code> file contains the UMI counts, while the other two files contain the cell barcodes and the gene annotation. We can load this into memory using the <code>read10xCounts</code> function, which returns a <code>SingleCellExperiment</code> object containing all of the relevant information. This includes the barcode sequence for each cell (column), as well as the identifier and symbol for each gene (row).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read10xCounts.html">read10xCounts</a></span><span class="op">(</span><span class="va">dir.name</span><span class="op">)</span>
<span class="va">sce</span></code></pre></div>
<pre><code>## class: SingleCellExperiment 
## dim: 100 10 
## metadata(1): Samples
## assays(1): counts
## rownames(100): ENSG00001 ENSG00002 ... ENSG000099 ENSG0000100
## rowData names(2): ID Symbol
## colnames: NULL
## colData names(2): Sample Barcode
## reducedDimNames(0):
## mainExpName: NULL
## altExpNames(0):</code></pre>
<p>The counts themselves are loaded as a sparse matrix, specifically a <code>dgCMatrix</code> from the <em><a href="https://CRAN.R-project.org/package=Matrix">Matrix</a></em> package. This reduces memory usage by only storing the non-zero counts, which is useful for sparse scRNA-seq data with lots of dropouts.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="fu">counts</span><span class="op">(</span><span class="va">sce</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "dgCMatrix"
## attr(,"package")
## [1] "Matrix"</code></pre>
<p>Users can also load multiple samples at once by supplying a character vector to <code>read10xCounts</code>. This will return a single <code>SingleCellExperiment</code> where all of the individual matrices are combined by column. Obviously, this only makes sense when the same set of genes is being used across samples.</p>
</div>
<div id="from-the-molecule-information-file" class="section level2">
<h2 class="hasAnchor">
<a href="#from-the-molecule-information-file" class="anchor"></a>From the molecule information file</h2>
<p><em>CellRanger</em> will also produce a molecule information file (<code>molecule_info.h5</code>) that contains… well, information about the transcript molecules. This includes the UMI sequence<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>, the cell barcode sequence, the gene to which it was assigned, and the number of reads covering the molecule. For demonstration purposes, we create an example molecule information file below:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>
<span class="va">mol.info.file</span> <span class="op">&lt;-</span> <span class="fu">DropletUtils</span><span class="fu">:::</span><span class="fu">simBasicMolInfo</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">mol.info.file</span></code></pre></div>
<pre><code>## [1] "C:\\Users\\Zaza\\AppData\\Local\\Temp\\RtmpmkKmwA\\file6f481ba631d5"</code></pre>
<p>We can subsequently load this information into our R session using the <code>read10xMolInfo</code> function:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mol.info</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read10xMolInfo.html">read10xMolInfo</a></span><span class="op">(</span><span class="va">mol.info.file</span><span class="op">)</span>
<span class="va">mol.info</span></code></pre></div>
<pre><code>## $data
## DataFrame with 9532 rows and 5 columns
##             cell       umi gem_group      gene     reads
##      &lt;character&gt; &lt;integer&gt; &lt;integer&gt; &lt;integer&gt; &lt;integer&gt;
## 1           TGTT     80506         1        18         8
## 2           CAAT    722585         1        20         6
## 3           AGGG    233634         1         4         6
## 4           TCCC    516870         1        10         9
## 5           ATAG    887407         1         6        12
## ...          ...       ...       ...       ...       ...
## 9528        TACT   1043995         1         9        12
## 9529        GCTG    907401         1        20        13
## 9530        ATTA    255710         1        13        10
## 9531        GCAC    672962         1        20        11
## 9532        TGAA    482852         1         1         6
## 
## $genes
##  [1] "ENSG1"  "ENSG2"  "ENSG3"  "ENSG4"  "ENSG5"  "ENSG6"  "ENSG7"  "ENSG8" 
##  [9] "ENSG9"  "ENSG10" "ENSG11" "ENSG12" "ENSG13" "ENSG14" "ENSG15" "ENSG16"
## [17] "ENSG17" "ENSG18" "ENSG19" "ENSG20"</code></pre>
<p>This information can be useful for quality control purposes, especially when the underlying read counts are required, e.g., to investigate sequencing saturation. Note that the function will automatically guess the length of the barcode sequence, as this is not formally defined in the molecule information file. For most experiments, the guess is correct, but users can force the function to use a known barcode length with the <code>barcode.length</code> argument.</p>
</div>
</div>
<div id="downsampling-on-the-reads" class="section level1">
<h1 class="hasAnchor">
<a href="#downsampling-on-the-reads" class="anchor"></a>Downsampling on the reads</h1>
<p>Given multiple batches of very different sequencing depths, it can be beneficial to downsample the deepest batches to match the coverage of the shallowest batches. This avoids differences in technical noise that can drive clustering by batch. The <em><a href="https://bioconductor.org/packages/3.13/scuttle">scuttle</a></em> package provides some utilities to downsample count matrices, but technically speaking, downsampling on the reads is more appropriate as it recapitulates the effect of differences in sequencing depth per cell. This can be achieved by applying the <code>downsampleReads</code> function to the molecule information file containing the read counts:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>
<span class="va">no.sampling</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/downsampleReads.html">downsampleReads</a></span><span class="op">(</span><span class="va">mol.info.file</span>, prop<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">no.sampling</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 9532</code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">with.sampling</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/downsampleReads.html">downsampleReads</a></span><span class="op">(</span><span class="va">mol.info.file</span>, prop<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">with.sampling</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 9457</code></pre>
<p>The above code will downsample the <strong>reads</strong> to 50% of the original coverage across the experiment. However, the function will return a matrix of <strong>UMI counts</strong>, so the final total count may not actually decrease if the libraries are sequenced to to saturation! Users should use <code><a href="https://rdrr.io/pkg/scuttle/man/downsampleMatrix.html">downsampleMatrix()</a></code> instead if they want to guarantee similar total counts after downsampling.</p>
</div>
<div id="computing-barcode-ranks" class="section level1">
<h1 class="hasAnchor">
<a href="#computing-barcode-ranks" class="anchor"></a>Computing barcode ranks</h1>
<p>A useful diagnostic for droplet-based data is the barcode rank plot, which shows the (log-)total UMI count for each barcode on the y-axis and the (log-)rank on the x-axis. This is effectively a transposed empirical cumulative density plot with log-transformed axes. It is useful as it allows users to examine the distribution of total counts across barcodes, focusing on those with the largest counts. To demonstrate, let us mock up a count matrix:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>
<span class="va">my.counts</span> <span class="op">&lt;-</span> <span class="fu">DropletUtils</span><span class="fu">:::</span><span class="fu">simCounts</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>We compute the statistics using the <code>barcodeRanks</code> function, and then create the plot as shown below.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">br.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/barcodeRanks.html">barcodeRanks</a></span><span class="op">(</span><span class="va">my.counts</span><span class="op">)</span>

<span class="co"># Making a plot.</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">br.out</span><span class="op">$</span><span class="va">rank</span>, <span class="va">br.out</span><span class="op">$</span><span class="va">total</span>, log<span class="op">=</span><span class="st">"xy"</span>, xlab<span class="op">=</span><span class="st">"Rank"</span>, ylab<span class="op">=</span><span class="st">"Total"</span><span class="op">)</span>
<span class="va">o</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">br.out</span><span class="op">$</span><span class="va">rank</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">br.out</span><span class="op">$</span><span class="va">rank</span><span class="op">[</span><span class="va">o</span><span class="op">]</span>, <span class="va">br.out</span><span class="op">$</span><span class="va">fitted</span><span class="op">[</span><span class="va">o</span><span class="op">]</span>, col<span class="op">=</span><span class="st">"red"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>h<span class="op">=</span><span class="fu">metadata</span><span class="op">(</span><span class="va">br.out</span><span class="op">)</span><span class="op">$</span><span class="va">knee</span>, col<span class="op">=</span><span class="st">"dodgerblue"</span>, lty<span class="op">=</span><span class="fl">2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>h<span class="op">=</span><span class="fu">metadata</span><span class="op">(</span><span class="va">br.out</span><span class="op">)</span><span class="op">$</span><span class="va">inflection</span>, col<span class="op">=</span><span class="st">"forestgreen"</span>, lty<span class="op">=</span><span class="fl">2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span><span class="st">"bottomleft"</span>, lty<span class="op">=</span><span class="fl">2</span>, col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"dodgerblue"</span>, <span class="st">"forestgreen"</span><span class="op">)</span>, 
    legend<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"knee"</span>, <span class="st">"inflection"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="DropletUtils_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>The knee and inflection points on the curve mark the transition between two components of the total count distribution. This is assumed to represent the difference between empty droplets with little RNA and cell-containing droplets with much more RNA, though a more rigorous method for distinguishing between these two possibilities is discussed below.</p>
</div>
<div id="detecting-empty-droplets" class="section level1">
<h1 class="hasAnchor">
<a href="#detecting-empty-droplets" class="anchor"></a>Detecting empty droplets</h1>
<p>Empty droplets often contain RNA from the ambient solution, resulting in non-zero counts after debarcoding. The <code>emptyDrops</code> function is designed to distinguish between empty droplets and cells. It does so by testing each barcode’s expression profile for significant deviation from the ambient profile. Given a matrix <code>my.counts</code> containing UMI counts for <strong>all</strong> barcodes, we call:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>
<span class="va">e.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emptyDrops.html">emptyDrops</a></span><span class="op">(</span><span class="va">my.counts</span><span class="op">)</span>
<span class="va">e.out</span></code></pre></div>
<pre><code>## DataFrame with 11100 rows and 5 columns
##           Total   LogProb    PValue   Limited        FDR
##       &lt;integer&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;logical&gt;  &lt;numeric&gt;
## 1             2        NA        NA        NA         NA
## 2             9        NA        NA        NA         NA
## 3            20        NA        NA        NA         NA
## 4            20        NA        NA        NA         NA
## 5             1        NA        NA        NA         NA
## ...         ...       ...       ...       ...        ...
## 11096       215  -246.428 9.999e-05      TRUE 0.00013799
## 11097       201  -250.234 9.999e-05      TRUE 0.00013799
## 11098       247  -275.905 9.999e-05      TRUE 0.00013799
## 11099       191  -228.763 9.999e-05      TRUE 0.00013799
## 11100       198  -233.043 9.999e-05      TRUE 0.00013799</code></pre>
<p>Droplets with significant deviations from the ambient profile are detected at a specified FDR threshold, e.g., with <code>FDR</code> below 1%. These can be considered to be cell-containing droplets, with a frequency of false positives (i.e., empty droplets) at the specified FDR. Furthermore, droplets with very large counts are automatically retained by setting their <em>p</em>-values to zero. This avoids discarding droplets containing cells that are very similar to the ambient profile.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">is.cell</span> <span class="op">&lt;-</span> <span class="va">e.out</span><span class="op">$</span><span class="va">FDR</span> <span class="op">&lt;=</span> <span class="fl">0.01</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">is.cell</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 943</code></pre>
<p>The <em>p</em>-values are calculated by permutation testing, hence the need to set a seed. The <code>Limited</code> field indicates whether a lower p-value could be obtained by increasing the number of permutations. If there are any entries with <code>FDR</code> above the desired threshold and <code>Limited==TRUE</code>, it indicates that <code>npts</code> should be increased in the <code>emptyDrops</code> call.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span>Limited<span class="op">=</span><span class="va">e.out</span><span class="op">$</span><span class="va">Limited</span>, Significant<span class="op">=</span><span class="va">is.cell</span><span class="op">)</span></code></pre></div>
<pre><code>##        Significant
## Limited FALSE TRUE
##   FALSE   357  843
##   TRUE      0  100</code></pre>
<p>We recommend making some diagnostic plots such as the total count against the negative log-probability. Droplets detected as cells should show up with large negative log-probabilities <em>or</em> very large total counts (based on the knee point reported by <code>barcodeRanks</code>). Note that the example below is based on simulated data and is quite exaggerated.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">e.out</span><span class="op">$</span><span class="va">Total</span>, <span class="op">-</span><span class="va">e.out</span><span class="op">$</span><span class="va">LogProb</span>, col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">is.cell</span>, <span class="st">"red"</span>, <span class="st">"black"</span><span class="op">)</span>,
    xlab<span class="op">=</span><span class="st">"Total UMI count"</span>, ylab<span class="op">=</span><span class="st">"-Log Probability"</span><span class="op">)</span></code></pre></div>
<p><img src="DropletUtils_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
</div>
<div id="demultiplexing-hashed-libraries" class="section level1">
<h1 class="hasAnchor">
<a href="#demultiplexing-hashed-libraries" class="anchor"></a>Demultiplexing hashed libraries</h1>
<p>Cell hashing experiments can be demultiplexed using the <code><a href="../reference/hashedDrops.html">hashedDrops()</a></code> function on the set of cell-containing barcode libraries. To demonstrate, we will mock up some hash tag oligo (HTO) counts for a population with cells from each of 10 samples. We will also add some doublets and empty droplets for some flavor:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">10000</span><span class="op">)</span>

<span class="co"># Simulating empty droplets:</span>
<span class="va">nbarcodes</span> <span class="op">&lt;-</span> <span class="fl">1000</span>
<span class="va">nhto</span> <span class="op">&lt;-</span> <span class="fl">10</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span><span class="op">(</span><span class="va">nbarcodes</span><span class="op">*</span><span class="va">nhto</span>, <span class="fl">20</span><span class="op">)</span>, nrow<span class="op">=</span><span class="va">nhto</span><span class="op">)</span>

<span class="co"># Simulating cells:</span>
<span class="va">ncells</span> <span class="op">&lt;-</span> <span class="fl">100</span>
<span class="va">true.sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">nhto</span>, <span class="va">ncells</span>, replace<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="va">y</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">true.sample</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">ncells</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1000</span>

<span class="co"># Simulating doublets:</span>
<span class="va">ndoub</span> <span class="op">&lt;-</span> <span class="va">ncells</span><span class="op">/</span><span class="fl">10</span>
<span class="va">next.sample</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">true.sample</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">ndoub</span><span class="op">]</span>  <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%%</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>
<span class="va">next.sample</span><span class="op">[</span><span class="va">next.sample</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>
<span class="va">y</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">next.sample</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">ndoub</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">500</span></code></pre></div>
<p>Our first task is to identify the barcodes that actually contain cells. If we already did the calling with <code><a href="../reference/emptyDrops.html">emptyDrops()</a></code>, we could just re-use those calls; otherwise we can obtain calls directly from the HTO count matrix, though this requires some fiddling with <code>lower=</code> to match the sequencing depth of the HTO library.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">hto.calls</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emptyDrops.html">emptyDrops</a></span><span class="op">(</span><span class="va">y</span>, lower<span class="op">=</span><span class="fl">500</span><span class="op">)</span>
<span class="va">has.cell</span> <span class="op">&lt;-</span> <span class="va">hto.calls</span><span class="op">$</span><span class="va">FDR</span> <span class="op">&lt;=</span> <span class="fl">0.001</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">has.cell</span><span class="op">)</span></code></pre></div>
<pre><code>##    Mode    TRUE    NA's 
## logical     100     900</code></pre>
<p>Each cell-containing barcode libary is simply assigned to the sample of origin based on its most abundant HTO. The confidence of the assignment is quantified by the log-fold change between the top and second-most abundant HTOs. The function will automatically adjust for differences in the ambient levels of each HTO based on the ambient profile; if this is not provided, it is roughly estimated the ambient profile from the supplied count matrix.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">demux</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hashedDrops.html">hashedDrops</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">has.cell</span><span class="op">)</span><span class="op">]</span>, 
    ambient<span class="op">=</span><span class="fu">metadata</span><span class="op">(</span><span class="va">hto.calls</span><span class="op">)</span><span class="op">$</span><span class="va">ambient</span><span class="op">)</span>
<span class="va">demux</span></code></pre></div>
<pre><code>## DataFrame with 100 rows and 7 columns
##         Total      Best    Second     LogFC    LogFC2   Doublet Confident
##     &lt;numeric&gt; &lt;integer&gt; &lt;integer&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;logical&gt; &lt;logical&gt;
## 1        1657         4         5  0.999462   4.60496      TRUE     FALSE
## 2        1635         8         9  0.999492   4.84165      TRUE     FALSE
## 3        1669         6         7  0.999473   4.45073      TRUE     FALSE
## 4        1674         6         7  0.999491   4.49983      TRUE     FALSE
## 5        1645         3         4  1.000292   4.74602      TRUE     FALSE
## ...       ...       ...       ...       ...       ...       ...       ...
## 96       1167         3         1   5.31708  0.427468     FALSE      TRUE
## 97       1158         3         1   5.26081  0.526363     FALSE      TRUE
## 98       1179         4         9   5.00121  0.604380     FALSE      TRUE
## 99       1187         2         5   5.37410  0.196833     FALSE      TRUE
## 100      1177         5         8   5.15739  0.464633     FALSE      TRUE</code></pre>
<p>It is then a simple matter to determine the sample of origin for each cell. We provide <code>Confident</code> calls to indicate which cells are confident singlets, based on the whether they are (i) not doublets and (ii) do not have small log-fold changes between the top and second HTO. The definition of “small” is relative and can be changed with the <code>nmad=</code> argument.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">demux</span><span class="op">$</span><span class="va">Best</span><span class="op">[</span><span class="va">demux</span><span class="op">$</span><span class="va">Confident</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<pre><code>## 
##  1  2  3  4  5  6  7  8  9 10 
## 10 15  9  7 12  8  6  6 10  6</code></pre>
<p>We also identify doublets based on the log-fold change between the second HTO’s abundance and the ambient contamination. A large log-fold change indicates that the second HTO exceeds that from contamination, consistent with the presence of a doublet.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">colors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">demux</span><span class="op">$</span><span class="va">Confident</span>, <span class="st">"black"</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">demux</span><span class="op">$</span><span class="va">Doublet</span>, <span class="st">"red"</span>, <span class="st">"grey"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">demux</span><span class="op">$</span><span class="va">LogFC</span>, <span class="va">demux</span><span class="op">$</span><span class="va">LogFC2</span>, col<span class="op">=</span><span class="va">colors</span>,
    xlab<span class="op">=</span><span class="st">"Log-fold change between best and second HTO"</span>,
    ylab<span class="op">=</span><span class="st">"Log-fold change between second HTO and ambient"</span><span class="op">)</span></code></pre></div>
<p><img src="DropletUtils_files/figure-html/unnamed-chunk-18-1.png" width="700"></p>
</div>
<div id="removing-swapping-effects" class="section level1">
<h1 class="hasAnchor">
<a href="#removing-swapping-effects" class="anchor"></a>Removing swapping effects</h1>
<div id="barcode-swapping-between-samples" class="section level2">
<h2 class="hasAnchor">
<a href="#barcode-swapping-between-samples" class="anchor"></a>Barcode swapping between samples</h2>
<p>Barcode swapping is a phenomenon that occurs upon multiplexing samples on the Illumina 4000 sequencer. Molecules from one sample are incorrectly labelled with <em>sample</em> barcodes from another sample, resulting in their misassignment upon demultiplexing. Fortunately, droplet experiments provide a unique opportunity to eliminate this effect, by assuming that it is effectively impossible to generate multiple molecules with the same combination of cell barcode, assigned gene and UMI sequence. Thus, any molecules with the same combination across multiple samples are likely to arise from barcode swapping.</p>
<p>The <code>swappedDrops</code> function will identify overlapping combinations in the molecule information files of all multiplexed 10X samples sequenced on the same run. It will remove these combinations and return “cleaned” UMI count matrices for all samples to use in downstream analyses. To demonstrate, we mock up a set of molecule information files for three multiplexed 10X samples:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>
<span class="va">mult.mol.info</span> <span class="op">&lt;-</span> <span class="fu">DropletUtils</span><span class="fu">:::</span><span class="fu">simSwappedMolInfo</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span><span class="op">)</span>, nsamples<span class="op">=</span><span class="fl">3</span><span class="op">)</span>
<span class="va">mult.mol.info</span></code></pre></div>
<pre><code>## [1] "C:\\Users\\Zaza\\AppData\\Local\\Temp\\RtmpmkKmwA\\file6f48a7f6abe.1.h5"
## [2] "C:\\Users\\Zaza\\AppData\\Local\\Temp\\RtmpmkKmwA\\file6f48a7f6abe.2.h5"
## [3] "C:\\Users\\Zaza\\AppData\\Local\\Temp\\RtmpmkKmwA\\file6f48a7f6abe.3.h5"</code></pre>
<p>We then apply <code>swappedDrops</code> to these files to remove the effect of swapping in our count matrices.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">s.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/swappedDrops.html">swappedDrops</a></span><span class="op">(</span><span class="va">mult.mol.info</span>, min.frac<span class="op">=</span><span class="fl">0.9</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">s.out</span><span class="op">$</span><span class="va">cleaned</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 3</code></pre>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">s.out</span><span class="op">$</span><span class="va">cleaned</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "dgCMatrix"
## attr(,"package")
## [1] "Matrix"</code></pre>
<p>For combinations where 90% of the reads belong to a single sample, the molecule is assigned to that sample rather than being removed. This assumes that swapping is relatively rare, so that the read count should be highest in the sample of origin. The exact percentage can be tuned by altering <code>min.frac</code> in the <code>swappedDrops</code> call.</p>
</div>
<div id="chimeric-reads-within-cells" class="section level2">
<h2 class="hasAnchor">
<a href="#chimeric-reads-within-cells" class="anchor"></a>Chimeric reads within cells</h2>
<p>On occasion, chimeric molecules are generated during library preparation where incomplete PCR products from one cDNA molecule hybridise to another molecule for extension using shared sequences like the poly-A tail for 3’ protocols. This produces an amplicon where the UMI and cell barcode originate from one transcript molecule but the gene sequence is from another, equivalent to swapping of reads between genes. We handle this effect by removing all molecules in the same cell with the same UMI sequence using the <code><a href="../reference/chimericDrops.html">chimericDrops()</a></code> function. This is applied below to a molecule information file to obtain a single cleaned count matrix for the relevant sample.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/chimericDrops.html">chimericDrops</a></span><span class="op">(</span><span class="va">mult.mol.info</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "list"</code></pre>
<p>Of course, this may also remove non-chimeric molecules that have the same UMI by chance, but for typical UMI lengths (10-12 bp for 10X protocols) we expect UMI collisions to be very rare between molecules from the same cell. Nonetheless, to mitigate losses due to collisions, we retain any molecule that has a much greater number of reads compared to all other molecules with the same UMI in the same cell.</p>
</div>
</div>
<div id="session-information" class="section level1">
<h1 class="hasAnchor">
<a href="#session-information" class="anchor"></a>Session information</h1>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## R version 4.1.0 (2021-05-18)
## Platform: x86_64-w64-mingw32/x64 (64-bit)
## Running under: Windows 10 x64 (build 21390)
## 
## Matrix products: default
## 
## locale:
## [1] LC_COLLATE=English_United States.1252 
## [2] LC_CTYPE=English_United States.1252   
## [3] LC_MONETARY=English_United States.1252
## [4] LC_NUMERIC=C                          
## [5] LC_TIME=English_United States.1252    
## system code page: 936
## 
## attached base packages:
## [1] parallel  stats4    stats     graphics  grDevices utils     datasets 
## [8] methods   base     
## 
## other attached packages:
##  [1] Matrix_1.3-4                DropletUtils_1.13.2        
##  [3] SingleCellExperiment_1.14.1 SummarizedExperiment_1.22.0
##  [5] Biobase_2.52.0              GenomicRanges_1.44.0       
##  [7] GenomeInfoDb_1.28.1         IRanges_2.26.0             
##  [9] S4Vectors_0.30.0            BiocGenerics_0.38.0        
## [11] MatrixGenerics_1.4.0        matrixStats_0.59.0         
## [13] knitr_1.33                  BiocStyle_2.20.2           
## 
## loaded via a namespace (and not attached):
##  [1] Rcpp_1.0.6                locfit_1.5-9.4           
##  [3] lattice_0.20-44           rprojroot_2.0.2          
##  [5] digest_0.6.27             R6_2.5.0                 
##  [7] evaluate_0.14             highr_0.9                
##  [9] sparseMatrixStats_1.4.0   zlibbioc_1.38.0          
## [11] rlang_0.4.11              jquerylib_0.1.4          
## [13] R.utils_2.10.1            R.oo_1.24.0              
## [15] rmarkdown_2.9             pkgdown_1.6.1            
## [17] textshaping_0.3.5         desc_1.3.0               
## [19] BiocParallel_1.26.1       stringr_1.4.0            
## [21] RCurl_1.98-1.3            beachmat_2.8.0           
## [23] DelayedArray_0.18.0       HDF5Array_1.20.0         
## [25] compiler_4.1.0            xfun_0.24                
## [27] systemfonts_1.0.2         htmltools_0.5.1.1        
## [29] GenomeInfoDbData_1.2.6    bookdown_0.22            
## [31] edgeR_3.34.0              crayon_1.4.1             
## [33] rhdf5filters_1.4.0        bitops_1.0-7             
## [35] R.methodsS3_1.8.1         grid_4.1.0               
## [37] jsonlite_1.7.2            magrittr_2.0.1           
## [39] dqrng_0.3.0               stringi_1.6.2            
## [41] cachem_1.0.5              scuttle_1.2.0            
## [43] XVector_0.32.0            fs_1.5.0                 
## [45] limma_3.48.1              bslib_0.2.5.1            
## [47] DelayedMatrixStats_1.14.0 ragg_1.1.3               
## [49] Rhdf5lib_1.14.2           tools_4.1.0              
## [51] fastmap_1.1.0             yaml_2.2.1               
## [53] rhdf5_2.36.0              BiocManager_1.30.16      
## [55] memoise_2.0.0             sass_0.4.0</code></pre>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>If you use the “filtered” matrix, each column corresponds to a putative cell. If you use the “raw” matrix, all barcodes are loaded, and no distinction is made between cells and empty droplets.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>For readers who are unfamiliar with UMIs, they allow reads from different PCR amplicons to be unambiguously assigned to the same original molecule.<a href="#fnref2" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Aaron Lun.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
