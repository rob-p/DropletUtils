<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Ambient contribution by maximum scaling — ambientContribMaximum • DropletUtils</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Ambient contribution by maximum scaling — ambientContribMaximum" />
<meta property="og:description" content="Compute the maximum contribution of the ambient solution to an expression profile for a group of droplets,
by scaling the ambient profile and testing for significant deviations in the count profile." />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">DropletUtils</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.13.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/DropletUtils.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Ambient contribution by maximum scaling</h1>
    
    <div class="hidden name"><code>ambientContribMaximum.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Compute the maximum contribution of the ambient solution to an expression profile for a group of droplets,
by scaling the ambient profile and testing for significant deviations in the count profile.</p>
    </div>

    <pre class="usage"><span class='fu'>maximumAmbience</span><span class='op'>(</span><span class='va'>...</span><span class='op'>)</span>

<span class='fu'>ambientContribMaximum</span><span class='op'>(</span><span class='va'>y</span>, <span class='va'>...</span><span class='op'>)</span>

<span class='co'># S4 method for ANY</span>
<span class='fu'>ambientContribMaximum</span><span class='op'>(</span>
  <span class='va'>y</span>,
  <span class='va'>ambient</span>,
  threshold <span class='op'>=</span> <span class='fl'>0.1</span>,
  dispersion <span class='op'>=</span> <span class='fl'>0</span>,
  num.points <span class='op'>=</span> <span class='fl'>100</span>,
  num.iter <span class='op'>=</span> <span class='fl'>5</span>,
  mode <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"scale"</span>, <span class='st'>"profile"</span>, <span class='st'>"proportion"</span><span class='op'>)</span>,
  BPPARAM <span class='op'>=</span> <span class='fu'>SerialParam</span><span class='op'>(</span><span class='op'>)</span>
<span class='op'>)</span>

<span class='co'># S4 method for SummarizedExperiment</span>
<span class='fu'>ambientContribMaximum</span><span class='op'>(</span><span class='va'>y</span>, <span class='va'>...</span>, assay.type <span class='op'>=</span> <span class='st'>"counts"</span><span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>...</th>
      <td><p>For the generic, further arguments to pass to individual methods.</p>
<p>For the SummarizedExperiment method, further arguments to pass to the ANY method.</p>
<p>For <code>controlAmbience</code>, arguments to pass to <code>ambientContribMaximum</code>.</p></td>
    </tr>
    <tr>
      <th>y</th>
      <td><p>A numeric matrix-like object containing counts, where each row represents a gene and each column represents a cluster of cells (see Caveats).</p>
<p>Alternatively, a SummarizedExperiment object containing such a matrix.</p>
<p><code>y</code> can also be a numeric vector of counts; this is coerced into a one-column matrix.</p></td>
    </tr>
    <tr>
      <th>ambient</th>
      <td><p>A numeric vector of length equal to <code><a href='https://rdrr.io/r/base/nrow.html'>nrow(y)</a></code>,
containing the proportions of transcripts for each gene in the ambient solution.
Alternatively, a matrix where each row corresponds to a row of <code>y</code>
and each column contains a specific ambient profile for the corresponding column of <code>y</code>.</p></td>
    </tr>
    <tr>
      <th>threshold</th>
      <td><p>Numeric scalar specifying the p-value threshold to use, see Details.</p></td>
    </tr>
    <tr>
      <th>dispersion</th>
      <td><p>Numeric scalar specifying the dispersion to use in the negative binomial model.
Defaults to zero, i.e., a Poisson model.</p></td>
    </tr>
    <tr>
      <th>num.points</th>
      <td><p>Integer scalar specifying the number of points to use for the grid search.</p></td>
    </tr>
    <tr>
      <th>num.iter</th>
      <td><p>Integer scalar specifying the number of iterations to use for the grid search.</p></td>
    </tr>
    <tr>
      <th>mode</th>
      <td><p>String indicating the output to return, see Value.</p></td>
    </tr>
    <tr>
      <th>BPPARAM</th>
      <td><p>A BiocParallelParam object specifying how parallelization should be performed.</p></td>
    </tr>
    <tr>
      <th>assay.type</th>
      <td><p>Integer or string specifying the assay containing the count matrix.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>If <code>mode="scale"</code>,
a numeric vector is returned quantifying the maximum &#8220;contribution&#8221; of the ambient solution to each column of <code>y</code>.
Scaling <code>ambient</code> by each entry yields the maximum ambient profile for the corresponding column of <code>y</code>.</p>
<p>If <code>mode="profile"</code>, a numeric matrix is returned containing the maximum ambient profile for each column of <code>y</code>.
This is computed by scaling as described above; if <code>ambient</code> is a matrix, each column is scaled by the corresponding entry of the scaling vector.</p>
<p>If <code>mode="proportion"</code>, a numeric matrix is returned containing the maximum proportion of counts in <code>y</code> that are attributable to ambient contamination.
This is computed by simply dividing the output of <code>mode="profile"</code> by <code>y</code> and capping all values at 1.</p>
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>On occasion, it is useful to estimate the maximum possible contribution of the ambient solution to a count profile.
This represents the most pessimistic explanation of a particular expression pattern
and can be used to identify and discard suspect genes or clusters prior to downstream analyses.</p>
<p>This function implements the following algorithm:</p><ol>
<li><p>We compute the mean ambient contribution for each gene by scaling <code>ambient</code> by some factor.
<code>ambient</code> itself is usually derived by summing counts across barcodes with low total counts,
see the output of <code><a href='emptyDrops.html'>emptyDrops</a></code> for an example.</p></li>
<li><p>We compute a p-value for each gene based on the probability of observing a count equal to or below that in <code>y</code>, using the lower tail of a negative binomial (or Poisson) distribution with mean set to the ambient contribution.
The per-gene null hypothesis is that the expected count in <code>y</code> is equal to the sum of the scaled ambient proportion and some (non-negative) contribution from actual intra-cellular transcripts.</p></li>
<li><p>We combine p-values across all genes using Simes' method.
This represents the evidence against the joint null hypothesis (that all of the per-gene nulls are true).</p></li>
<li><p>We find the largest scaling factor that fails to reject this joint null at the specified <code>threshold</code>.
If <code><a href='https://rdrr.io/r/base/sum.html'>sum(ambient)</a></code> is equal to unity, this scaling factor can be interpreted as the maximum number of transcript molecules contributed to <code>y</code> by the ambient solution.</p></li>
</ol>

<p>The process of going from a scaling factor to a combined p-value has no clean analytical solution,
so we use an iterative grid search to identify to largest possible scaling factor at a decent resolution.
<code>num.points</code> and <code>num.iter</code> control the resolution of the grid search,
and generally do not need to be changed.</p>
<p><code>maximumAmbience</code> is soft-deprecated; use <code>ambientContribMaximum</code> instead.</p>
    <h2 class="hasAnchor" id="caveats"><a class="anchor" href="#caveats"></a>Caveats</h2>

    

<p>The above algorithm is rather <em>ad hoc</em> and offers little in the way of theoretical guarantees.
The p-value is used as a score rather than providing any meaningful error control.
Empirically, increasing <code>threshold</code> will return a higher scaling factor by making the estimation more robust to drop-outs in <code>y</code>, at the cost of increasing the risk of over-estimation of the ambient contribution.</p>
<p>Our abuse of the p-value machinery means that the reported scaling often exceeds the actual contribution, especially at low counts where the reduced power fails to penalize overly large scaling factors.
Hence, the function works best when <code>y</code> contains aggregated counts for one or more groups of droplets with the same expected expression profile, e.g., clusters of related cells.
Higher counts provide more power to detect deviations, hopefully leading to a more accurate estimate of the scaling factor.
(On a practical note, this function is rather slow so it is more feasible to calculate on cluster-level profiles rather than per cell.)</p>
<p>Note that this function returns the <em>maximum possible</em> contribution of the ambient solution to <code>y</code>, not the actual contribution.
In the most extreme case, if the ambient profile is similar to the expectation of <code>y</code> (e.g., due to sequencing a relatively homogeneous cell population), the maximum possible contribution of the ambient solution would be 100% of <code>y</code>, and subtraction would yield an empty count vector!</p>
    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <div class='dont-index'><p><code><a href='ambientProfileEmpty.html'>ambientProfileEmpty</a></code> and <code><a href='ambientProfileBimodal.html'>ambientProfileBimodal</a></code>, to estimate the ambient profile.</p>
<p><code><a href='ambientContribSparse.html'>ambientContribSparse</a></code> and <code><a href='ambientContribNegative.html'>ambientContribNegative</a></code>, for other methods to estimate the ambient contribution.</p>
<p><code><a href='emptyDrops.html'>emptyDrops</a></code>, which uses the ambient profile to call cells.</p>
<p><code><a href='ambientProfileEmpty.html'>ambientProfileEmpty</a></code> or <code><a href='ambientProfileBimodal.html'>ambientProfileBimodal</a></code>, to obtain an estimate to use in <code>ambient</code>.</p>
<p><code><a href='ambientContribNegative.html'>ambientContribNegative</a></code> or <code><a href='ambientContribSparse.html'>ambientContribSparse</a></code>, for other methods of estimating the contribution.</p></div>
    <h2 class="hasAnchor" id="author"><a class="anchor" href="#author"></a>Author</h2>

    <p>Aaron Lun</p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='co'># Making up some data for, e.g., a single cluster.</span>
<span class='va'>ambient</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/stats/Uniform.html'>runif</a></span><span class='op'>(</span><span class='fl'>900</span>, <span class='fl'>0</span>, <span class='fl'>0.1</span><span class='op'>)</span>, <span class='fu'><a href='https://rdrr.io/r/stats/Uniform.html'>runif</a></span><span class='op'>(</span><span class='fl'>100</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>y</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Poisson.html'>rpois</a></span><span class='op'>(</span><span class='fl'>1000</span>, <span class='va'>ambient</span> <span class='op'>*</span> <span class='fl'>100</span><span class='op'>)</span>
<span class='va'>y</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>100</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>y</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>100</span><span class='op'>]</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/stats/Poisson.html'>rpois</a></span><span class='op'>(</span><span class='fl'>100</span>, <span class='fl'>20</span><span class='op'>)</span> <span class='co'># actual biology.</span>

<span class='co'># Estimating the maximum possible scaling factor:</span>
<span class='va'>scaling</span> <span class='op'>&lt;-</span> <span class='fu'>ambientContribMaximum</span><span class='op'>(</span><span class='va'>y</span>, <span class='va'>ambient</span><span class='op'>)</span>
<span class='va'>scaling</span>
</div><div class='output co'>#&gt; [1] 121.2124</div><div class='input'>
<span class='co'># Estimating the maximum contribution to 'y' by 'ambient'.</span>
<span class='va'>contribution</span> <span class='op'>&lt;-</span> <span class='fu'>ambientContribMaximum</span><span class='op'>(</span><span class='va'>y</span>, <span class='va'>ambient</span>, mode<span class='op'>=</span><span class='st'>"profile"</span><span class='op'>)</span>
<span class='fu'>DataFrame</span><span class='op'>(</span>ambient<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/drop.html'>drop</a></span><span class='op'>(</span><span class='va'>contribution</span><span class='op'>)</span>, total<span class='op'>=</span><span class='va'>y</span><span class='op'>)</span>
</div><div class='output co'>#&gt; DataFrame with 1000 rows and 2 columns
#&gt;         ambient     total
#&gt;       &lt;numeric&gt; &lt;integer&gt;
#&gt; 1     0.9787917        20
#&gt; 2    10.1131500        32
#&gt; 3     7.2819662        26
#&gt; 4     1.9055611        15
#&gt; 5     0.0896904        27
#&gt; ...         ...       ...
#&gt; 996    120.5087       116
#&gt; 997     44.6739        33
#&gt; 998     40.8908        31
#&gt; 999    110.7500        83
#&gt; 1000   110.2330       101</div><div class='input'>
</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Aaron Lun.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


