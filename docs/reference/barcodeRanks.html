<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Calculate barcode ranks — barcodeRanks • DropletUtils</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Calculate barcode ranks — barcodeRanks" />
<meta property="og:description" content="Compute barcode rank statistics and identify the knee and inflection points on the total count curve." />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">DropletUtils</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.13.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/DropletUtils.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Calculate barcode ranks</h1>
    
    <div class="hidden name"><code>barcodeRanks.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Compute barcode rank statistics and identify the knee and inflection points on the total count curve.</p>
    </div>

    <pre class="usage"><span class='fu'>barcodeRanks</span><span class='op'>(</span><span class='va'>m</span>, <span class='va'>...</span><span class='op'>)</span>

<span class='co'># S4 method for ANY</span>
<span class='fu'>barcodeRanks</span><span class='op'>(</span>
  <span class='va'>m</span>,
  lower <span class='op'>=</span> <span class='fl'>100</span>,
  fit.bounds <span class='op'>=</span> <span class='cn'>NULL</span>,
  exclude.from <span class='op'>=</span> <span class='fl'>50</span>,
  df <span class='op'>=</span> <span class='fl'>20</span>,
  <span class='va'>...</span>,
  BPPARAM <span class='op'>=</span> <span class='fu'>SerialParam</span><span class='op'>(</span><span class='op'>)</span>
<span class='op'>)</span>

<span class='co'># S4 method for SummarizedExperiment</span>
<span class='fu'>barcodeRanks</span><span class='op'>(</span><span class='va'>m</span>, <span class='va'>...</span>, assay.type <span class='op'>=</span> <span class='st'>"counts"</span><span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>m</th>
      <td><p>A numeric matrix-like object containing UMI counts, where columns represent barcoded droplets and rows represent genes.
Alternatively, a SummarizedExperiment containing such a matrix.</p></td>
    </tr>
    <tr>
      <th>...</th>
      <td><p>For the generic, further arguments to pass to individual methods.</p>
<p>For the SummarizedExperiment method, further arguments to pass to the ANY method.</p>
<p>For the ANY method, further arguments to pass to <code><a href='https://rdrr.io/r/stats/smooth.spline.html'>smooth.spline</a></code>.</p></td>
    </tr>
    <tr>
      <th>lower</th>
      <td><p>A numeric scalar specifying the lower bound on the total UMI count, 
at or below which all barcodes are assumed to correspond to empty droplets.</p></td>
    </tr>
    <tr>
      <th>fit.bounds</th>
      <td><p>A numeric vector of length 2, specifying the lower and upper bounds on the total UMI count
from which to obtain a section of the curve for spline fitting.</p></td>
    </tr>
    <tr>
      <th>exclude.from</th>
      <td><p>An integer scalar specifying the number of highest ranking barcodes to exclude from spline fitting.
Ignored if <code>fit.bounds</code> is specified.</p></td>
    </tr>
    <tr>
      <th>df</th>
      <td><p>Integer scalar specifying the number of degrees of freedom, to pass to <code><a href='https://rdrr.io/r/stats/smooth.spline.html'>smooth.spline</a></code>.</p></td>
    </tr>
    <tr>
      <th>BPPARAM</th>
      <td><p>A BiocParallelParam object specifying how parallelization should be performed.</p></td>
    </tr>
    <tr>
      <th>assay.type</th>
      <td><p>Integer or string specifying the assay containing the count matrix.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>A DataFrame where each row corresponds to a column of <code>m</code>, and containing the following fields:</p><dl>
<dt><code>rank</code>:</dt><dd><p>Numeric, the rank of each barcode (averaged across ties).</p></dd>
<dt><code>total</code>:</dt><dd><p>Numeric, the total counts for each barcode.</p></dd>
<dt><code>fitted</code>:</dt><dd><p>Numeric, the fitted value from the spline for each barcode.
This is <code>NA</code> for points with <code>x</code> outside of <code>fit.bounds</code>.</p></dd>

</dl>

<p>The metadata contains <code>knee</code>, a numeric scalar containing the total count at the knee point;
and <code>inflection</code>, a numeric scalar containing the total count at the inflection point.</p>
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>Analyses of droplet-based scRNA-seq data often show a plot of the log-total count against the log-rank of each barcode
where the highest ranks have the largest totals.
This is equivalent to a transposed empirical cumulative density plot with log-transformed axes, 
which focuses on the barcodes with the largest counts.
To help create this plot, the <code>barcodeRanks</code> function will compute these ranks for all barcodes in <code>m</code>.
Barcodes with the same total count receive the same average rank to avoid problems with discrete runs of the same total.</p>
<p>The function will also identify the inflection and knee points on the curve for downstream use, 
Both of these points correspond to a sharp transition between two components of the total count distribution, 
presumably reflecting the difference between empty droplets with little RNA and cell-containing droplets with much more RNA.</p><ul>
<li><p>The inflection point is computed as the point on the rank/total curve where the first derivative is minimized.
The derivative is computed directly from all points on the curve with total counts greater than <code>lower</code>.
This avoids issues with erratic behaviour of the curve at lower totals.</p></li>
<li><p>The knee point is defined as the point on the curve where the signed curvature is minimized.
This requires calculation of the second derivative, which is much more sensitive to noise in the curve.
To overcome this, a smooth spline is fitted to the log-total counts against the log-rank using <code><a href='https://rdrr.io/r/stats/smooth.spline.html'>smooth.spline</a></code>.
Derivatives are then calculated from the fitted spline using <code><a href='https://rdrr.io/r/stats/predict.html'>predict</a></code>.</p></li>
</ul>

    <h2 class="hasAnchor" id="details-on-curve-fitting"><a class="anchor" href="#details-on-curve-fitting"></a>Details on curve fitting</h2>

    

<p>We supply a relatively low default setting of <code>df</code> to avoid overfitting the spline, 
as this results in unstability in the higher derivatives (and thus the curvature).
<code>df</code> and other arguments to <code><a href='https://rdrr.io/r/stats/smooth.spline.html'>smooth.spline</a></code> can be tuned 
if the estimated knee point is not at an appropriate location.
We also restrict the fit to lie within the bounds defined by <code>fit.bounds</code> to focus on the region containing the knee point.
This allows us to obtain an accurate fit with low <code>df</code> rather than attempting to model the entire curve.</p>
<p>If <code>fit.bounds</code> is not specified, the lower bound is automatically set to the inflection point
as this should lie below the knee point on typical curves.
The upper bound is set to the point at which the first derivative is closest to zero, 
i.e., the &#8220;plateau&#8221; region before the knee point.
The first <code>exclude.from</code> barcodes with the highest totals are ignored in this process 
to avoid spuriously large numerical derivatives from unstable parts of the curve with low point density.</p>
<p>Note that only points with total counts above <code>lower</code> will be considered for curve fitting,
regardless of how <code>fit.bounds</code> is defined.</p>
    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <div class='dont-index'><p><code><a href='emptyDrops.html'>emptyDrops</a></code>, where this function is used.</p></div>
    <h2 class="hasAnchor" id="author"><a class="anchor" href="#author"></a>Author</h2>

    <p>Aaron Lun</p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='co'># Mocking up some data: </span>
<span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>2000</span><span class='op'>)</span>
<span class='va'>my.counts</span> <span class='op'>&lt;-</span> <span class='fu'>DropletUtils</span><span class='fu'>:::</span><span class='fu'>simCounts</span><span class='op'>(</span><span class='op'>)</span>

<span class='co'># Computing barcode rank statistics:</span>
<span class='va'>br.out</span> <span class='op'>&lt;-</span> <span class='fu'>barcodeRanks</span><span class='op'>(</span><span class='va'>my.counts</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/names.html'>names</a></span><span class='op'>(</span><span class='va'>br.out</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] "rank"   "total"  "fitted"</div><div class='input'>
<span class='co'># Making a plot.</span>
<span class='fu'><a href='https://rdrr.io/r/graphics/plot.default.html'>plot</a></span><span class='op'>(</span><span class='va'>br.out</span><span class='op'>$</span><span class='va'>rank</span>, <span class='va'>br.out</span><span class='op'>$</span><span class='va'>total</span>, log<span class='op'>=</span><span class='st'>"xy"</span>, xlab<span class='op'>=</span><span class='st'>"Rank"</span>, ylab<span class='op'>=</span><span class='st'>"Total"</span><span class='op'>)</span>
</div><div class='output co'>#&gt; <span class='warning'>Warning: 400 y values &lt;= 0 omitted from logarithmic plot</span></div><div class='input'><span class='va'>o</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/order.html'>order</a></span><span class='op'>(</span><span class='va'>br.out</span><span class='op'>$</span><span class='va'>rank</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/graphics/lines.html'>lines</a></span><span class='op'>(</span><span class='va'>br.out</span><span class='op'>$</span><span class='va'>rank</span><span class='op'>[</span><span class='va'>o</span><span class='op'>]</span>, <span class='va'>br.out</span><span class='op'>$</span><span class='va'>fitted</span><span class='op'>[</span><span class='va'>o</span><span class='op'>]</span>, col<span class='op'>=</span><span class='st'>"red"</span><span class='op'>)</span>
</div><div class='input'><span class='fu'><a href='https://rdrr.io/r/graphics/abline.html'>abline</a></span><span class='op'>(</span>h<span class='op'>=</span><span class='fu'>metadata</span><span class='op'>(</span><span class='va'>br.out</span><span class='op'>)</span><span class='op'>$</span><span class='va'>knee</span>, col<span class='op'>=</span><span class='st'>"dodgerblue"</span>, lty<span class='op'>=</span><span class='fl'>2</span><span class='op'>)</span>
</div><div class='input'><span class='fu'><a href='https://rdrr.io/r/graphics/abline.html'>abline</a></span><span class='op'>(</span>h<span class='op'>=</span><span class='fu'>metadata</span><span class='op'>(</span><span class='va'>br.out</span><span class='op'>)</span><span class='op'>$</span><span class='va'>inflection</span>, col<span class='op'>=</span><span class='st'>"forestgreen"</span>, lty<span class='op'>=</span><span class='fl'>2</span><span class='op'>)</span>
</div><div class='input'><span class='fu'><a href='https://rdrr.io/r/graphics/legend.html'>legend</a></span><span class='op'>(</span><span class='st'>"bottomleft"</span>, lty<span class='op'>=</span><span class='fl'>2</span>, col<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"dodgerblue"</span>, <span class='st'>"forestgreen"</span><span class='op'>)</span>, 
    legend<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"knee"</span>, <span class='st'>"inflection"</span><span class='op'>)</span><span class='op'>)</span>
</div><div class='img'><img src='barcodeRanks-1.png' alt='' width='700' height='433' /></div><div class='input'>
</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Aaron Lun.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


