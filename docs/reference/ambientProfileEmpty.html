<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Estimate the ambient profile from empty droplets — ambientProfileEmpty • DropletUtils</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Estimate the ambient profile from empty droplets — ambientProfileEmpty" />
<meta property="og:description" content="Estimate the transcript proportions in the ambient solution from an unfiltered count matrix,
assuming that low-count barcodes correspond to &amp;#8220;known empty&amp;#8221; droplets.
Zeroes are filled in using the Good-Turing method." />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">DropletUtils</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.13.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/DropletUtils.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Estimate the ambient profile from empty droplets</h1>
    
    <div class="hidden name"><code>ambientProfileEmpty.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Estimate the transcript proportions in the ambient solution from an unfiltered count matrix,
assuming that low-count barcodes correspond to &#8220;known empty&#8221; droplets.
Zeroes are filled in using the Good-Turing method.</p>
    </div>

    <pre class="usage"><span class='fu'>estimateAmbience</span><span class='op'>(</span><span class='va'>...</span><span class='op'>)</span>

<span class='fu'>ambientProfileEmpty</span><span class='op'>(</span><span class='va'>m</span>, <span class='va'>...</span><span class='op'>)</span>

<span class='co'># S4 method for ANY</span>
<span class='fu'>ambientProfileEmpty</span><span class='op'>(</span>
  <span class='va'>m</span>,
  lower <span class='op'>=</span> <span class='fl'>100</span>,
  by.rank <span class='op'>=</span> <span class='cn'>NULL</span>,
  round <span class='op'>=</span> <span class='cn'>TRUE</span>,
  good.turing <span class='op'>=</span> <span class='cn'>TRUE</span>,
  BPPARAM <span class='op'>=</span> <span class='fu'>SerialParam</span><span class='op'>(</span><span class='op'>)</span>
<span class='op'>)</span>

<span class='co'># S4 method for SummarizedExperiment</span>
<span class='fu'>ambientProfileEmpty</span><span class='op'>(</span><span class='va'>m</span>, <span class='va'>...</span>, assay.type <span class='op'>=</span> <span class='st'>"counts"</span><span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>...</th>
      <td><p>For the generic, further arguments to pass to individual methods.</p>
<p>For the SummarizedExperiment method, further arguments to pass to the ANY method.</p>
<p>For <code>estimateAmbience</code>, arguments to pass to <code>ambientProfileEmpty</code>.</p></td>
    </tr>
    <tr>
      <th>m</th>
      <td><p>A numeric matrix-like object - usually a dgTMatrix or dgCMatrix - 
containing droplet data <em>prior to any filtering or cell calling</em>.
Columns represent barcoded droplets, rows represent genes.</p>
<p>For <code>emptyDrops</code>, this may also be a SummarizedExperiment object containing such a matrix.</p></td>
    </tr>
    <tr>
      <th>lower</th>
      <td><p>A numeric scalar specifying the lower bound on the total UMI count, 
at or below which all barcodes are assumed to correspond to empty droplets.</p></td>
    </tr>
    <tr>
      <th>by.rank</th>
      <td><p>An integer scalar or vector of length 2, used as an alternative to <code>lower</code> to identifying assumed empty droplets - see Details.</p></td>
    </tr>
    <tr>
      <th>round</th>
      <td><p>Logical scalar indicating whether to check for non-integer values in <code>m</code> and, if present, round them for ambient profile estimation (see <code>?ambientProfileEmpty</code>) and the multinomial simulations.</p></td>
    </tr>
    <tr>
      <th>good.turing</th>
      <td><p>Logical scalar indicating whether to perform Good-Turing estimation of the proportions.</p></td>
    </tr>
    <tr>
      <th>BPPARAM</th>
      <td><p>A BiocParallelParam object indicating whether parallelization should be used.</p></td>
    </tr>
    <tr>
      <th>assay.type</th>
      <td><p>Integer or string specifying the assay containing the count matrix.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>A numeric vector of length equal to <code><a href='https://rdrr.io/r/base/nrow.html'>nrow(m)</a></code>,
containing the estimated proportion of each transcript in the ambient solution.</p>
<p>If <code>good.turing=FALSE</code>, the vector instead contains the sum of counts for each gene across all low-count barcodes.</p>
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>This function obtains an estimate of the composition of the ambient pool of RNA based on the barcodes with total UMI counts less than or equal to <code>lower</code>.
For each gene, counts are summed across all low-count barcodes and the resulting count vector is used for Good-Turing estimation of the proportions for each transcript.
The aim here is to obtain reasonable proportions for genes with counts of zero in low-count barcodes but non-zero counts for other barcodes (thus avoiding likelihoods of zero when modelling the latter with the proportions).</p>
<p>This function will also attempt to detect whether <code>m</code> contains non-integer values by seeing if the column and row sums are discrete.
If such values are present, <code>m</code> is first <code><a href='https://rdrr.io/r/base/Round.html'>round</a></code>ed to the nearest integer value before proceeding.
This may be relevant when the count matrix is generated from pseudo-alignment methods like Alevin (see the <span class="pkg">tximeta</span> package for details).
Rounding is performed by default as discrete count values are necessary for the Good-Turing algorithm, but if <code>m</code> is known to be discrete, setting <code>round=FALSE</code> can provide a small efficiency improvement.</p>
<p>Setting <code>good.turing=FALSE</code> may be convenient to obtain raw counts for use in further modelling.</p>
<p><code>estimateAmbience</code> is soft-deprecated; use <code>ambientProfileEmpty</code> instead.</p>
    <h2 class="hasAnchor" id="behavior-at-zero-counts"><a class="anchor" href="#behavior-at-zero-counts"></a>Behavior at zero counts</h2>

    

<p>Good-Turing returns zero probabilities for zero counts if none of the summed counts are equal to 1.
This is technically correct but not helpful, so we protect against this by adding a single &#8220;pseudo-feature&#8221; with a count of 1 to the profile.
The modified profile is used to calculate a Good-Turing estimate of observing any feature that has zero counts, which is then divided to get the per-feature probability. 
We scale down all the other probabilities to make space for this new pseudo-probability, which has some properties of unclear utility (see <a href='https://github.com/MarioniLab/DropletUtils/issues/39'>https://github.com/MarioniLab/DropletUtils/issues/39</a>).</p>
<p>Note that genes with counts of zero across all barcodes in <code>m</code> automatically have proportions of zero.
This ensures that the estimation is not affected by the presence/absence of non-expressed genes in different annotations.
In any case, such genes are likely to be completely irrelevant to downstream steps and can be safely ignored.</p>
    <h2 class="hasAnchor" id="finding-the-assumed-empty-droplets"><a class="anchor" href="#finding-the-assumed-empty-droplets"></a>Finding the assumed empty droplets</h2>

    

<p>The default approach is to assume that all barcodes with total counts less than or equal to <code>lower</code> are empty.
This is generally effective but may not be adequate for datasets with unusually low or high sequencing depth, such that all or none of the barcodes are detected as empty respectively.
For example, there is no obvious choice for <code>lower</code> in CITE-seq data given that the coverage can be highly variable.</p>
<p>In such cases, an alternative approach can be used by passing an integer to the <code>by.rank</code> argument.
This specifies the number of barcodes with the highest total counts to ignore; the remaining barcodes are assumed to be ambient.
The idea is that, even if the exact threshold is unknown, we can be certain that a given experiment does not contain more than a particular number of genuine cell-containing barcodes based on the number of cells that were loaded into the machine.
By setting <code>by.rank</code> to something greater than this <em>a priori</em> known number, we exclude the most likely candidates and use the remaining barcodes to compute the ambient profile.</p>
    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <div class='dont-index'><p><code><a href='emptyDrops.html'>emptyDrops</a></code> and <code><a href='hashedDrops.html'>hashedDrops</a></code>, where the ambient profile estimates are used for testing.</p>
<p><code><a href='ambientContribMaximum.html'>ambientContribMaximum</a></code> and related functions, to estimate the contribution of ambient contamination in each library.</p></div>
    <h2 class="hasAnchor" id="author"><a class="anchor" href="#author"></a>Author</h2>

    <p>Aaron Lun</p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='co'># Mocking up some data:</span>
<span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>0</span><span class='op'>)</span>
<span class='va'>my.counts</span> <span class='op'>&lt;-</span> <span class='fu'>DropletUtils</span><span class='fu'>:::</span><span class='fu'>simCounts</span><span class='op'>(</span><span class='op'>)</span>

<span class='va'>ambience</span> <span class='op'>&lt;-</span> <span class='fu'>ambientProfileEmpty</span><span class='op'>(</span><span class='va'>my.counts</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/utils/head.html'>head</a></span><span class='op'>(</span><span class='va'>ambience</span><span class='op'>)</span>
</div><div class='output co'>#&gt;        GENE1        GENE2        GENE3        GENE4        GENE5        GENE6 
#&gt; 0.0002213677 0.0003984648 0.0006331183 0.0008146427 0.0010935705 0.0012042561 </div><div class='input'>
</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Aaron Lun.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


