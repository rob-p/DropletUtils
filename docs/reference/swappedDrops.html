<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Clean barcode-swapped droplet data — swappedDrops • DropletUtils</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Clean barcode-swapped droplet data — swappedDrops" />
<meta property="og:description" content="Remove the effects of barcode swapping on droplet-based single-cell RNA-seq data, specifically 10X Genomics datasets." />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">DropletUtils</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.13.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/DropletUtils.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Clean barcode-swapped droplet data</h1>
    
    <div class="hidden name"><code>swappedDrops.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Remove the effects of barcode swapping on droplet-based single-cell RNA-seq data, specifically 10X Genomics datasets.</p>
    </div>

    <pre class="usage"><span class='fu'>swappedDrops</span><span class='op'>(</span><span class='va'>samples</span>, barcode.length <span class='op'>=</span> <span class='cn'>NULL</span>, use.library <span class='op'>=</span> <span class='cn'>NULL</span>, <span class='va'>...</span><span class='op'>)</span>

<span class='fu'>removeSwappedDrops</span><span class='op'>(</span>
  <span class='va'>cells</span>,
  <span class='va'>umis</span>,
  <span class='va'>genes</span>,
  <span class='va'>nreads</span>,
  <span class='va'>ref.genes</span>,
  min.frac <span class='op'>=</span> <span class='fl'>0.8</span>,
  get.swapped <span class='op'>=</span> <span class='cn'>FALSE</span>,
  get.diagnostics <span class='op'>=</span> <span class='cn'>FALSE</span>,
  hdf5.out <span class='op'>=</span> <span class='cn'>FALSE</span>
<span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>samples</th>
      <td><p>A character vector containing paths to the molecule information HDF5 files, 
produced by CellRanger for 10X Genomics data.
Each file corresponds to one sample in a multiplexed pool.</p></td>
    </tr>
    <tr>
      <th>barcode.length</th>
      <td><p>An integer scalar specifying the length of the cell barcode, see <code><a href='read10xMolInfo.html'>read10xMolInfo</a></code>.</p></td>
    </tr>
    <tr>
      <th>use.library</th>
      <td><p>An integer scalar specifying the library index for which to extract molecules from <code>sample</code>.
Alternatively, a string specifying the library type, e.g., <code>"Gene expression"</code>.</p></td>
    </tr>
    <tr>
      <th>...</th>
      <td><p>Further arguments to be passed to <code>removeSwappedDrops</code>.</p></td>
    </tr>
    <tr>
      <th>cells</th>
      <td><p>A list of character vectors containing cell barcodes.
Each vector corresponds to one sample in a multiplexed pool, and each entry of the vector corresponds to one molecule.</p></td>
    </tr>
    <tr>
      <th>umis</th>
      <td><p>A list of integer vectors containing encoded UMI sequences, organized as described for <code>cells</code>.
See <code>?<a href='encodeSequences.html'>encodeSequences</a></code> to convert sequences to integers.</p></td>
    </tr>
    <tr>
      <th>genes</th>
      <td><p>A list of integer vectors specifying the gene indices, organized as described for <code>cells</code>.
Each index should refer to an element of <code>ref.genes</code>.</p></td>
    </tr>
    <tr>
      <th>nreads</th>
      <td><p>A list of integer vectors containing the number of reads per molecule, organized as described for <code>cells</code>.</p></td>
    </tr>
    <tr>
      <th>ref.genes</th>
      <td><p>A character vector containing the names or symbols of all genes.</p></td>
    </tr>
    <tr>
      <th>min.frac</th>
      <td><p>A numeric scalar specifying the minimum fraction of reads required for a swapped molecule to be assigned to a sample.</p></td>
    </tr>
    <tr>
      <th>get.swapped</th>
      <td><p>A logical scalar indicating whether the UMI counts corresponding to swapped molecules should be returned.</p></td>
    </tr>
    <tr>
      <th>get.diagnostics</th>
      <td><p>A logical scalar indicating whether to return the number of reads for each molecule in each sample.</p></td>
    </tr>
    <tr>
      <th>hdf5.out</th>
      <td><p>Deprecated and ignored.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>A list is returned with the <code>cleaned</code> entry, itself a list of sparse matrices.
Each matrix corresponds to a sample and contains the UMI count for each gene (row) and cell barcode (column) after removing swapped molecules.
All cell barcodes that were originally observed are reported as columns, though note that it is possible for some barcodes to contain no counts.</p>
<p>If <code>get.swapped=TRUE</code>, a <code>swapped</code> entry is returned in the top-level list.
This is a list containing sample-specific sparse matrices of UMI counts corresponding to the swapped molecules.
Adding the cleaned and swapped matrices for each sample should yield the total UMI count prior to removal of swapped molecules.</p>
<p>If <code>get.diagnostics=TRUE</code>, the top-level list will also contain an additional <code>diagnostics</code> matrix.</p>
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>Barcode swapping on the Illumina sequencer occurs when multiplexed samples undergo PCR re-amplification on the flow cell by excess primer with different barcodes.
This results in sequencing of the wrong sample barcode and molecules being assigned to incorrect samples after debarcoding.
With droplet data, there is the opportunity to remove such effects based on the combination of gene, UMI and cell barcode for each observed transcript molecule.
It is very unlikely that the same combination will arise from different molecules in multiple samples.
Thus, observation of the same combination across multiple samples is indicative of barcode swapping.</p>
<p>We can remove swapped molecules based on the number of reads assigned to each gene-UMI-barcode combination.
From the total number of reads assigned to that combination, the fraction of reads in each sample is calculated.
The sample with the largest fraction that is greater than <code>min.frac</code> is defined as the putative sample of origin to which the molecule is assigned.
This assumes that the swapping rate is low, so the sample of origin for a molecule should contain the majority of the reads.
In other all samples, reads for the combination are assumed to derive from swapping and do not contribute to the count matrix.
Setting <code>min.frac=1</code> will effectively remove all molecules that appear in multiple samples.
We do not recommend setting <code>min.frac</code> lower than 0.5.</p>
<p>If <code>diagnostics=TRUE</code>, a diagnostics matrix is returned containing the number of reads per gene-UMI-barcode combination in each sample.
Each row corresponds to a combination and each column corresponds to a sample.
This can be useful for examining the level of swapping across samples on a molecule-by-molecule basis, 
though for the sake of memory, the actual identity of the molecules is not returned.
By default, the matrix is returned as a HDF5Matrix, which reduces memory usage and avoids potential issues with integer overflow.
If <code>hdf5.out=FALSE</code>, a sparse matrix is returned instead, which is faster but uses more memory.</p>
<p><code>swappedDrops</code> is a wrapper around <code>removeSwappedDrops</code> that extracts the relevant data from the 10X Genomics molecule information file.
For other types of droplet-based data, it may be more convenient to call <code>removeSwappedDrops</code> directly.</p>
    <h2 class="hasAnchor" id="format-of-the-molecule-information-file"><a class="anchor" href="#format-of-the-molecule-information-file"></a>Format of the molecule information file</h2>

    

<p><code>swappedDrops</code> makes a few assumptions about the nature of the data in each molecule information file.
These are necessary to simplify downstream processing and are generally acceptable in most cases.</p>
<p>Each molecule information file should contain data from only a single 10X run.
Users should <em>not</em> combine multiple samples into a single molecule information file.
The function will emit a warning upon detecting multiple GEM groups from any molecule information file.
Molecules with different GEM groups will not be recognised as coming from a different sample, though they will be recognised as being derived from different cell-level libraries.</p>
<p>In files produced by CellRanger version 3.0, an additional per-molecule field is present indicating the (c)DNA library from which the molecule was derived.
Library preparation can be performed separately for different features (e.g., antibodies, CRISPR tags) such that one 10X run can contain data from multiple libraries.
This allows for arbitrarily complicated multiplexing schemes - for example, gene expression libraries might be multiplexed together across one set of samples,
while the antibody-derived libraries might be multiplexed across another <em>different</em> set of samples.
For simplicity, we assume that multiplexing was performed across the same set of <code>samples</code> for all libraries therein.</p>
<p>If a different multiplexing scheme was applied for each library type, users can set <code>use.library</code> to only check for swapping within a given library type(s).
For example, if the multiplexed set of samples for the gene expression libraries is different from the multiplexed set for the CRISPR libraries,
one could run <code>swappedDrops</code> separately on each set of samples with <code>use.library</code> set to the corresponding type. 
This avoids having to take the union of both sets of samples for a single <code>swappedDrops</code> run,
which could detect spurious swaps between samples that were never multiplexed together for the same library type.</p>
    <h2 class="hasAnchor" id="references"><a class="anchor" href="#references"></a>References</h2>

    <p>Griffiths JA, Lun ATL, Richard AC, Bach K, Marioni JC (2018).
Detection and removal of barcode swapping in single-cell RNA-seq data.
<em>Nat. Commun.</em> 9, 1:2667.</p>
    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <div class='dont-index'><p><code><a href='read10xMolInfo.html'>read10xMolInfo</a></code>,
<code><a href='encodeSequences.html'>encodeSequences</a></code></p></div>
    <h2 class="hasAnchor" id="author"><a class="anchor" href="#author"></a>Author</h2>

    <p>Jonathan Griffiths,
with modifications by Aaron Lun</p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='co'># Mocking up some 10x HDF5-formatted data, with swapping.</span>
<span class='va'>curfiles</span> <span class='op'>&lt;-</span> <span class='fu'>DropletUtils</span><span class='fu'>:::</span><span class='fu'>simSwappedMolInfo</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/tempfile.html'>tempfile</a></span><span class='op'>(</span><span class='op'>)</span>, nsamples<span class='op'>=</span><span class='fl'>3</span><span class='op'>)</span>

<span class='co'># Obtaining count matrices with swapping removed.</span>
<span class='va'>out</span> <span class='op'>&lt;-</span> <span class='fu'>swappedDrops</span><span class='op'>(</span><span class='va'>curfiles</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/lapply.html'>lapply</a></span><span class='op'>(</span><span class='va'>out</span><span class='op'>$</span><span class='va'>cleaned</span>, <span class='va'>dim</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [[1]]
#&gt; [1]  20 256
#&gt; 
#&gt; [[2]]
#&gt; [1]  20 256
#&gt; 
#&gt; [[3]]
#&gt; [1]  20 256
#&gt; </div><div class='input'>
<span class='va'>out</span> <span class='op'>&lt;-</span> <span class='fu'>swappedDrops</span><span class='op'>(</span><span class='va'>curfiles</span>, get.swapped<span class='op'>=</span><span class='cn'>TRUE</span>, get.diagnostics<span class='op'>=</span><span class='cn'>TRUE</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/names.html'>names</a></span><span class='op'>(</span><span class='va'>out</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] "cleaned"     "swapped"     "diagnostics"</div><div class='input'>
</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Aaron Lun.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


